<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2014-11-25
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20141125" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Transport Abstraction Package - Trap - CPD Results</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>TrAP Parent</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2014-11-25</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 1.3</li>
                          <li class="divider">|</li>             <li class="">
                    <a href="index.html" title="Trap">
        Trap</a>
        </li>
      <li class="divider ">/</li>
        <li class="">CPD Results</li>
                
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Trap 1.3</li>
                                
      <li>
    
                          <a href="index.html" title="Introduction">
          <i class="none"></i>
        Introduction</a>
            </li>
                  
      <li>
    
                          <a href="trap-api/quickstart.html" title="Java Quickstart">
          <i class="none"></i>
        Java Quickstart</a>
            </li>
                  
      <li>
    
                          <a href="trap-js/index.html" title="JavaScript Quickstart">
          <i class="none"></i>
        JavaScript Quickstart</a>
            </li>
                  
      <li>
    
                          <a href="channels.html" title="Channels">
          <i class="none"></i>
        Channels</a>
            </li>
                  
      <li>
    
                          <a href="configuration.html" title="Configuration">
          <i class="none"></i>
        Configuration</a>
            </li>
                              <li class="nav-header">Language Specific Documentation</li>
                                
      <li>
    
                          <a href="trap-api/index.html" title="Java">
          <i class="none"></i>
        Java</a>
            </li>
                  
      <li>
    
                          <a href="trap-js/index.html" title="JavaScript">
          <i class="none"></i>
        JavaScript</a>
            </li>
                              <li class="nav-header">Modules</li>
                                
      <li>
    
                          <a href="trap-utils-api/index.html" title="TrAP Utils API">
          <i class="none"></i>
        TrAP Utils API</a>
            </li>
                  
      <li>
    
                          <a href="trap-utils-15/index.html" title="TrAP Utils JDK 1.5">
          <i class="none"></i>
        TrAP Utils JDK 1.5</a>
            </li>
                  
      <li>
    
                          <a href="trap-network/index.html" title="Trap Networking Layer">
          <i class="none"></i>
        Trap Networking Layer</a>
            </li>
                  
      <li>
    
                          <a href="trap-api/index.html" title="TrAP API">
          <i class="none"></i>
        TrAP API</a>
            </li>
                  
      <li>
    
                          <a href="trap-core/index.html" title="TrAP Core">
          <i class="none"></i>
        TrAP Core</a>
            </li>
                  
      <li>
    
                          <a href="trap-js/index.html" title="TrAP JavaScript">
          <i class="none"></i>
        TrAP JavaScript</a>
            </li>
                  
      <li>
    
                          <a href="transports/index.html" title="TrAP Transports">
          <i class="none"></i>
        TrAP Transports</a>
            </li>
                  
      <li>
    
                          <a href="trap-tests-parent/index.html" title="TrAP Packaging Parent">
          <i class="none"></i>
        TrAP Packaging Parent</a>
            </li>
                  
      <li>
    
                          <a href="package-parent/index.html" title="TrAP Packaging Parent">
          <i class="none"></i>
        TrAP Packaging Parent</a>
            </li>
                  
      <li>
    
                          <a href="trap-android/index.html" title="TrAP Android Library">
          <i class="none"></i>
        TrAP Android Library</a>
            </li>
                  
      <li>
    
                          <a href="trap-index-maven-plugin/index.html" title="Index Maven Plugin">
          <i class="none"></i>
        Index Maven Plugin</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                                                                                                                                                                                                                                
      <li>
    
                          <a href="project-info.html" title="Project Information">
          <i class="icon-chevron-right"></i>
        Project Information</a>
                  </li>
                                                                                                                                    
      <li>
    
                          <a href="project-reports.html" title="Project Reports">
          <i class="icon-chevron-down"></i>
        Project Reports</a>
                    <ul class="nav nav-list">
                      
      <li class="active">
    
            <a href="#"><i class="none"></i>CPD</a>
          </li>
                      
      <li>
    
                          <a href="pmd.html" title="PMD">
          <i class="none"></i>
        PMD</a>
            </li>
                      
      <li>
    
                          <a href="apidocs/index.html" title="JavaDocs">
          <i class="none"></i>
        JavaDocs</a>
            </li>
                      
      <li>
    
                          <a href="xref/index.html" title="Source Xref">
          <i class="none"></i>
        Source Xref</a>
            </li>
              </ul>
        </li>
            </ul>
                
                    
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="ericssonresearch.github.io/trap/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <div class="section">
<h2>CPD Results<a name="CPD_Results"></a></h2>
<p>The following document contains the results of PMD's  <a class="externalLink" href="http://pmd.sourceforge.net/cpd.html">CPD</a> 5.1.2.</p></div>
<div class="section">
<h2>Duplications<a name="Duplications"></a></h2>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="b">
<td>com/ericsson/research/transport/ws/spi/WSHybi10Handshake.java</td>
<td>TrAP Networking: Websockets Base</td>
<td><a href="./xref/com/ericsson/research/transport/ws/spi/WSHybi10Handshake.html#L82">82</a></td></tr>
<tr class="a">
<td>com/ericsson/research/transport/ws/spi/WSRfc6455Handshake.java</td>
<td>TrAP Networking: Websockets Base</td>
<td><a href="./xref/com/ericsson/research/transport/ws/spi/WSRfc6455Handshake.html#L82">82</a></td></tr>
<tr class="b"><td colspan='3'>
<div>
<pre>            h.append(8);
            h.append(CRLF);
            h.append(SEC_WEBSOCKET_KEY_HEADER);
            h.append(COLON_SPACE);
            byte[] randomBytes = new byte[16];
            random.nextBytes(randomBytes);
            this.key = new String(Base64.encode(randomBytes));
            h.append(this.key);
            h.append(CRLFCRLF);
        }
        else
        {
            h.append(SERVER_PREAMBLE);
            h.append(WSHixie75Handshake.COMMON_PART);
            h.append(SEC_WEBSOCKET_ACCEPT_HEADER);
            h.append(COLON_SPACE);
            String nounceAndGUID = this.key + GUID;
            try
            {
                byte[] sha1 = this.computeSHA1(nounceAndGUID);
                h.append(Base64.encode(sha1));
                h.append(CRLFCRLF);
            }
            catch (WSException e)
            {
                throw new IOException(e);
            }
        }
        synchronized (os)
        {
            os.write(h.toString().getBytes(ISO_8859_1));
            os.flush();
        }
    }
    
    public void headersRead() throws WSException
    {
        if (this.protocol.client)
        {
            byte[] expected = this.computeSHA1(this.key + GUID);
            if (this.getHeader(SEC_WEBSOCKET_ACCEPT_HEADER) == null)
                throw new WSException(&quot;Missing &quot; + SEC_WEBSOCKET_ACCEPT_HEADER + &quot; header&quot;);
            byte[] actual = Base64.decode(this.getHeader(SEC_WEBSOCKET_ACCEPT_HEADER));
            if (!Arrays.equals(expected, actual))
                throw new WSException(&quot;Failed to validate &quot; + SEC_WEBSOCKET_ACCEPT_HEADER + &quot; header value&quot;);
            this.protocol.protocol = this.getHeader(SEC_WEBSOCKET_PROTOCOL_HEADER);
        }
        else
        {
            if (this.getHeader(HOST_HEADER) == null)
                throw new WSException(&quot;Missing &quot; + HOST_HEADER + &quot; header&quot;);
            if (!&quot;8&quot;.equals(this.getHeader(SEC_WEBSOCKET_VERSION_HEADER)))</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="b">
<td>com/ericsson/research/trap/impl/ClientTrapEndpoint.java</td>
<td>TrAP Core</td>
<td><a href="./xref/com/ericsson/research/trap/impl/ClientTrapEndpoint.html#L246">246</a></td></tr>
<tr class="a">
<td>com/ericsson/research/trap/impl/TrapPeerImpl.java</td>
<td>TrAP Core</td>
<td><a href="./xref/com/ericsson/research/trap/impl/TrapPeerImpl.html#L455">455</a></td></tr>
<tr class="b"><td colspan='3'>
<div>
<pre>            if (this.logger.isDebugEnabled())
            {
                StringBuilder logMsg = new StringBuilder();
                logMsg.append(&quot;Lost a transport. TrapEndpont state is &quot;);
                logMsg.append(this.getState().toString());
                logMsg.append(&quot;. I have &quot;);
                logMsg.append(this.activeTransports.size());
                logMsg.append(&quot; active transports. Name/State follows... &quot;);
                
                synchronized (this.activeTransports)
                {
                    Iterator&lt;TrapTransport&gt; it = this.activeTransports.iterator();
                    
                    while (it.hasNext())
                    {
                        TrapTransport at = it.next();
                        logMsg.append(at.getTransportName());
                        logMsg.append(&quot;/&quot;);
                        logMsg.append(at.getState());
                        logMsg.append(&quot;, &quot;);
                    }
                }
                
                this.logger.debug(logMsg.toString());
            }
            
            if (this.getState() == TrapState.SLEEPING &amp;&amp; System.currentTimeMillis() &gt;= this.canReconnectUntil)
            {
                this.logger.debug(&quot;Timer expired on reconnect&quot;);
                this.setState(TrapState.CLOSED);
                return;
            }
            
            // This was an already connected transport. If we have other transports available, we should silently try and reconnect it in the background
            if ((oldState == TrapTransportState.AVAILABLE) || (oldState == TrapTransportState.UNAVAILABLE) || (oldState == TrapTransportState.CONNECTED))
            {
                
                if (this.activeTransports.size() != 0)</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="b">
<td>com/ericsson/research/trap/spi/transports/ServerWebSocketTransport.java</td>
<td>TrAP Transport WebSocket by ER NIO</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/ServerWebSocketTransport.html#L74">74</a></td></tr>
<tr class="a">
<td>com/ericsson/research/trap/spi/transports/WebServerSocketTransport.java</td>
<td>TrAP Transport WebSocket by Netty</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/WebServerSocketTransport.html#L82">82</a></td></tr>
<tr class="b"><td colspan='3'>
<div>
<pre>	}
	
	public void listen(ListenerTrapTransportDelegate listener, Object context) throws TrapException
	{
		this.listenerDelegate = listener;
		this.listenerContext = context;

		this.delegate = new TrapTransportDelegate() {

			@Override
			public void ttStateChanged(TrapTransportState newState, TrapTransportState oldState, TrapTransport transport, Object context)
			{
				// TODO Auto-generated method stub

			}

			@Override
			public void ttMessageReceived(TrapMessage message, TrapTransport transport, Object context)
			{
				// TODO Auto-generated method stub

			}

			@Override
			public void ttMessageSent(TrapMessage message, TrapTransport transport, Object context)
			{
				// TODO Auto-generated method stub
				
			}

            @Override
            public void ttMessagesFailedSending(Collection&lt;TrapMessage&gt; messages, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }

            @Override
            public void ttNeedTransport(TrapMessage message, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }
		};

		try
		{

			int port = 0;
			try
			{
				port = Integer.parseInt(this.getOption(WebSocketConstants.CONFIG_SERVER_PORT));
			}
			catch (Throwable t)
			{
			}

			this.host = this.getOption(WebSocketConstants.CONFIG_SERVER_HOST);

			if ((this.host == null) || (this.host.trim().length() == 0))
			{
				this.host = &quot;0.0.0.0&quot;;
				this.defaultHost = true;
			}</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="b">
<td>com/ericsson/research/trap/spi/transports/WebServerSocketTransport.java</td>
<td>TrAP Transport WebSocket by Netty</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/WebServerSocketTransport.html#L61">61</a></td></tr>
<tr class="a">
<td>com/ericsson/research/trap/spi/transports/TomcatWSListener.java</td>
<td>TrAP Transport WebSocket for Tomcat Container</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/TomcatWSListener.html#L68">68</a></td></tr>
<tr class="b"><td colspan='3'>
<div>
<pre>	public String getTransportName()
	{
		return &quot;websocket&quot;;
	}
	
	@Override
	public String getProtocolName()
	{
		return TrapTransportProtocol.WEBSOCKET;
	}

	@Override
	public boolean canConnect()
	{
		return false;
	}

	@Override
	public boolean canListen()
	{
		return true;
	}

	public void listen(ListenerTrapTransportDelegate listener, Object context) throws TrapException
	{
		this.listenerDelegate = listener;
		this.listenerContext = context;

		this.delegate = new TrapTransportDelegate() {

			@Override
			public void ttStateChanged(TrapTransportState newState, TrapTransportState oldState, TrapTransport transport, Object context)
			{
				// TODO Auto-generated method stub

			}

			@Override
			public void ttMessageReceived(TrapMessage message, TrapTransport transport, Object context)
			{
				// TODO Auto-generated method stub

			}

			@Override
			public void ttMessageSent(TrapMessage message, TrapTransport transport, Object context)
			{
				// TODO Auto-generated method stub
				
			}

            @Override
            public void ttMessagesFailedSending(Collection&lt;TrapMessage&gt; messages, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }

            @Override
            public void ttNeedTransport(TrapMessage message, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }
		};</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="b">
<td>com/ericsson/research/transport/ws/spi/WSHybi10Handshake.java</td>
<td>TrAP Networking: Websockets Base</td>
<td><a href="./xref/com/ericsson/research/transport/ws/spi/WSHybi10Handshake.html#L51">51</a></td></tr>
<tr class="a">
<td>com/ericsson/research/transport/ws/spi/WSRfc6455Handshake.java</td>
<td>TrAP Networking: Websockets Base</td>
<td><a href="./xref/com/ericsson/research/transport/ws/spi/WSRfc6455Handshake.html#L51">51</a></td></tr>
<tr class="b"><td colspan='3'>
<div>
<pre>    public WSHybi10Handshake(WSAbstractProtocol protocol)
    {
        super(protocol);
    }
    
    public void sendHandshake(OutputStream os) throws IOException
    {
        StringBuffer h = new StringBuffer();
        if (this.protocol.client)
        {
            h.append(GET);
            h.append(&quot; &quot;);
            h.append(this.protocol.resource);
            h.append(&quot; &quot;);
            h.append(HTTP11);
            h.append(WSHixie75Handshake.COMMON_PART);
            h.append(HOST_HEADER);
            h.append(COLON_SPACE);
            h.append(this.protocol.host);
            if ((this.protocol.securityContext == null &amp;&amp; this.protocol.port != 80) || (this.protocol.securityContext != null &amp;&amp; this.protocol.port != 443))
            {
                h.append(&quot;:&quot;);
                h.append(this.protocol.port);
            }
            h.append(CRLF);
            h.append(SEC_WEBSOCKET_ORIGIN_HEADER);</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="b">
<td>com/ericsson/research/trap/impl/http/HTTPServlet25.java</td>
<td>Trap HTTP Server using HTTPServlet interface</td>
<td><a href="./xref/com/ericsson/research/trap/impl/http/HTTPServlet25.html#L76">76</a></td></tr>
<tr class="a">
<td>com/ericsson/research/trap/impl/http/HTTPServlet30.java</td>
<td>Trap HTTP Server using HTTPServlet 3.0 interface</td>
<td><a href="./xref/com/ericsson/research/trap/impl/http/HTTPServlet30.html#L71">71</a></td></tr>
<tr class="b"><td colspan='3'>
<div>
<pre>        this.ctxPath = this.ctxPath + this.path;
        HTTPServletAdaptor.addServletContext(this.ctxPath);
    }
    
    @Override
    public void destroy()
    {
        HTTPServletAdaptor.removeServletContext(this.ctxPath);
    }
    
    @Override
    protected void service(HttpServletRequest arg0, HttpServletResponse arg1) throws ServletException, IOException
    {
        this.internalService(arg0, arg1);
    }
    
    @Override
    protected void doDelete(HttpServletRequest arg0, HttpServletResponse arg1) throws ServletException, IOException
    {
        this.internalService(arg0, arg1);
    }
    
    @Override
    protected void doGet(HttpServletRequest arg0, HttpServletResponse arg1) throws ServletException, IOException
    {
        this.internalService(arg0, arg1);
    }
    
    @Override
    protected void doPost(HttpServletRequest arg0, HttpServletResponse arg1) throws ServletException, IOException
    {
        this.internalService(arg0, arg1);
    }
    
    @Override
    protected void doPut(HttpServletRequest arg0, HttpServletResponse arg1) throws ServletException, IOException
    {
        this.internalService(arg0, arg1);
    }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="a">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="b">
<td>com/ericsson/research/trap/examples/EchoServer.java</td>
<td>TrAP API</td>
<td><a href="./xref/com/ericsson/research/trap/examples/EchoServer.html#L86">86</a></td></tr>
<tr class="a">
<td>com/ericsson/research/trap/examples/TLSEchoServer.java</td>
<td>TrAP API</td>
<td><a href="./xref/com/ericsson/research/trap/examples/TLSEchoServer.html#L108">108</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/examples/TLSInsecureEchoServer.java</td>
<td>TrAP API</td>
<td><a href="./xref/com/ericsson/research/trap/examples/TLSInsecureEchoServer.html#L89">89</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>        echoServer.listen(new EchoServer());
        
        // Now to tell clients how to connect. Since we elected no configuration, Trap will allocate random ports.
        clientConfig = echoServer.getClientConfiguration();
        System.out.println(&quot;New clients should connect to the following configuration:&quot;);
        System.out.println(echoServer.getClientConfiguration());
    }
    
    public void incomingTrapConnection(TrapEndpoint endpoint, TrapListener listener, Object context)
    {
        // Endpoints received by this method are NOT strongly referenced, and may be GC'd. Thus, we must retain
        clients.add(endpoint);
        
        // We also want feedback from the endpoint.
        endpoint.setDelegate(this, true);
    }
    
    public void trapData(byte[] data, int channel, TrapEndpoint endpoint, Object context)
    {
        // Log!
        System.out.println(&quot;Echo Server Got message: [&quot; + StringUtil.toUtfString(data) + &quot;] of length &quot; + data.length);
        
        try
        {
            // Echo the data back with the same parameters.
            endpoint.send(data, channel, false);
        }
        catch (TrapException e)
        {
            e.printStackTrace();
        }
    }
    
    public void trapClose(TrapEndpoint endpoint, Object context)
    {
        // Remove the strong reference to allow garbage collection
        clients.remove(endpoint);
    }
    
}</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/impl/queues/LinkedBlockingMessageQueue.java</td>
<td>TrAP Core</td>
<td><a href="./xref/com/ericsson/research/trap/impl/queues/LinkedBlockingMessageQueue.html#L122">122</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/impl/queues/LinkedMessageQueue.java</td>
<td>TrAP Core</td>
<td><a href="./xref/com/ericsson/research/trap/impl/queues/LinkedMessageQueue.html#L70">70</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>        }
    }
    
    public TrapMessage peek()
    {
        synchronized (this.messageQueue)
        {
            try
            {
                return this.messageQueue.get(0);
            }
            catch (IndexOutOfBoundsException e)
            {
                return null;
            }
        }
    }
    
    public TrapMessage pop()
    {
        synchronized (this.messageQueue)
        {
            try
            {
                TrapMessage m = this.messageQueue.remove(0);
                this.messageQueue.notifyAll();
                return m;
            }
            catch (IndexOutOfBoundsException e)
            {
                return null;
            }
        }
    }
    
    public long size()
    {
        return this.maxQueueSize;
    }
    
    public void resize(long newSize)
    {
        this.maxQueueSize = newSize;
    }
    
    public String getQueueType()
    {
        return TrapEndpoint.BLOCKING_MESSAGE_QUEUE;
    }
    
    public int length()
    {
        return this.messageQueue.size();
    }
    
    public long blockingTimeout()</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/examples/EchoClient.java</td>
<td>TrAP API</td>
<td><a href="./xref/com/ericsson/research/trap/examples/EchoClient.html#L96">96</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/examples/TLSInsecureEchoClient.java</td>
<td>TrAP API</td>
<td><a href="./xref/com/ericsson/research/trap/examples/TLSInsecureEchoClient.html#L95">95</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>        this.client = TrapFactory.createClient(trapCfg, true);
        
        // Tell the client to use us as a delegate.
        // We'll only handle two events this time: open and data
        this.client.setDelegate(this, true);
        
        // Start connecting.
        this.client.open();
    }
    
    // Called when the client is open (=ready to send)
    public void trapOpen(TrapEndpoint endpoint, Object context)
    {
        // Send a message!
        this.sendMessage();
    }
    
    // Called when the client receives data. Since we connect to the echo server, the same message should come back.
    public void trapData(byte[] data, int channel, TrapEndpoint endpoint, Object context)
    {
        System.out.println(&quot;Got message: &quot; + StringUtil.toUtfString(data));
        this.sendMessage();
    }
    
    private void sendMessage()
    {
        String message = &quot;Message {&quot; + this.counter++ + &quot;}&quot;;
        System.out.println(&quot;Now sending: &quot; + message);
        
        try
        {
            this.client.send(StringUtil.toUtfBytes(message));
        }
        catch (TrapException e)
        {
            e.printStackTrace();
        }
    }
    
}</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/spi/transports/ApacheClientHttpTransport.java</td>
<td>Trap HTTP Client using Apache HTTP client</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/ApacheClientHttpTransport.html#L142">142</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/spi/transports/ClientHttpTransport.java</td>
<td>Trap HTTP Client using Sun HTTP client</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/ClientHttpTransport.html#L168">168</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>    {
        
        synchronized (this.messagesToSend)
        {
            
            if ((this.getState() != TrapTransportState.CONNECTED) &amp;&amp; (this.getState() != TrapTransportState.AVAILABLE) &amp;&amp; (this.getState() != TrapTransportState.UNAVAILABLE) &amp;&amp; (message.getOp() != TrapMessage.Operation.CLOSE))
                throw new TrapTransportException(message, this.getState());
            
            if (message != null)
            {
                if (this.logger.isTraceEnabled())
                    this.logger.trace(&quot;[HTTP] Scheduling message {} with id {}&quot;, message.getOp(), message.getMessageId());
                // Don't slam messages yet
                this.messagesToSend.add(message);
            }
            
            if (expectMore)
                return;
            
            this.flushTransport();
            
        }
    }</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/spi/transports/WebSocketTransport.java</td>
<td>TrAP Transport WebSocket by Netty</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/WebSocketTransport.html#L107">107</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/spi/transports/TomcatWSTransport.java</td>
<td>TrAP Transport WebSocket for Tomcat Container</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/TomcatWSTransport.html#L112">112</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>							WebSocketTransport.this.flushTransport();
						}
					}, 1);
				}
				
				if (expectMore)
				{
					
					if (this.outBuf == null)
						this.outBuf = new ByteArrayOutputStream();
					
					this.outBuf.write(raw);
					return;
				}
				
				this.performSend(raw);
				
			}
		}
		catch (IOException e)
		{
			this.logger.debug(e.toString());
			this.setState(TrapTransportState.ERROR);
			throw new TrapTransportException(message, this.state);
		}
		catch (TrapTransportException e)
		{
			this.setState(TrapTransportState.ERROR);
			throw e;
		}
		catch (Throwable t)
		{
			t.printStackTrace();
		}
	}
	
	private void performSend(byte[] raw) throws IOException
	{</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/utils/Base64.java</td>
<td>TrAP Utils API</td>
<td><a href="./xref/com/ericsson/research/trap/utils/Base64.html#L122">122</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/utils/Base64.java</td>
<td>TrAP Utils API</td>
<td><a href="./xref/com/ericsson/research/trap/utils/Base64.html#L157">157</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>char[] out = new char[oLen];
int ip = iOff;
int iEnd = iOff + iLen;
int op = 0;
while (ip &lt; iEnd) {
   int i0 = in[ip++] &amp; 0xff;
   int i1 = ip &lt; iEnd ? in[ip++] &amp; 0xff : 0;
   int i2 = ip &lt; iEnd ? in[ip++] &amp; 0xff : 0;
   int o0 = i0 &gt;&gt;&gt; 2;
   int o1 = ((i0 &amp;   3) &lt;&lt; 4) | (i1 &gt;&gt;&gt; 4);
   int o2 = ((i1 &amp; 0xf) &lt;&lt; 2) | (i2 &gt;&gt;&gt; 6);
   int o3 = i2 &amp; 0x3F;
   out[op++] = map1[o0];</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/spi/transports/ServerWebSocketTransport.java</td>
<td>TrAP Transport WebSocket by ER NIO</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/ServerWebSocketTransport.html#L74">74</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/spi/transports/TomcatWSListener.java</td>
<td>TrAP Transport WebSocket for Tomcat Container</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/TomcatWSListener.html#L89">89</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>	}
	
	public void listen(ListenerTrapTransportDelegate listener, Object context) throws TrapException
	{
		this.listenerDelegate = listener;
		this.listenerContext = context;

		this.delegate = new TrapTransportDelegate() {

			@Override
			public void ttStateChanged(TrapTransportState newState, TrapTransportState oldState, TrapTransport transport, Object context)
			{
				// TODO Auto-generated method stub

			}

			@Override
			public void ttMessageReceived(TrapMessage message, TrapTransport transport, Object context)
			{
				// TODO Auto-generated method stub

			}

			@Override
			public void ttMessageSent(TrapMessage message, TrapTransport transport, Object context)
			{
				// TODO Auto-generated method stub
				
			}

            @Override
            public void ttMessagesFailedSending(Collection&lt;TrapMessage&gt; messages, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }

            @Override
            public void ttNeedTransport(TrapMessage message, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }
		};</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/impl/ClientTrapEndpoint.java</td>
<td>TrAP Core</td>
<td><a href="./xref/com/ericsson/research/trap/impl/ClientTrapEndpoint.html#L120">120</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/impl/TrapPeerImpl.java</td>
<td>TrAP Core</td>
<td><a href="./xref/com/ericsson/research/trap/impl/TrapPeerImpl.html#L204">204</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>        try
        {
            Class&lt;TrapTransport&gt;[] transports = TrapTransports.getTransportClasses(this.getClass().getClassLoader());
            
            for (int i = 0; i &lt; transports.length; i++)
            {
                if (!TrapTransport.class.isAssignableFrom(transports[i]) || transports[i].isAssignableFrom(AbstractTransport.class))
                    continue;
                
                TrapTransport t;
                
                try
                {
                    t = transports[i].newInstance();
                }
                catch (Exception e)
                {
                    this.logger.debug(&quot;Failed to instantiate {}; Most probably a server transport...&quot;, transports[i].getName(), e);
                    continue;
                }
                
                if (!t.canConnect())
                    continue;</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/examples/AutoConfiguredServer.java</td>
<td>TrAP API</td>
<td><a href="./xref/com/ericsson/research/trap/examples/AutoConfiguredServer.html#L85">85</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/examples/EchoServer.java</td>
<td>TrAP API</td>
<td><a href="./xref/com/ericsson/research/trap/examples/EchoServer.html#L91">91</a></td></tr>
<tr class="a">
<td>com/ericsson/research/trap/examples/TLSEchoServer.java</td>
<td>TrAP API</td>
<td><a href="./xref/com/ericsson/research/trap/examples/TLSEchoServer.html#L113">113</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/examples/TLSInsecureEchoServer.java</td>
<td>TrAP API</td>
<td><a href="./xref/com/ericsson/research/trap/examples/TLSInsecureEchoServer.html#L94">94</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>        System.out.println(clientConfig);
    }
    
    public void incomingTrapConnection(TrapEndpoint endpoint, TrapListener listener, Object context)
    {
        // Endpoints received by this method are NOT strongly referenced, and may be GC'd. Thus, we must retain
        clients.add(endpoint);
        
        // We also want feedback from the endpoint.
        endpoint.setDelegate(this, true);
    }
    
    public void trapData(byte[] data, int channel, TrapEndpoint endpoint, Object context)
    {
        // Log!
        System.out.println(&quot;Echo Server Got message: [&quot; + StringUtil.toUtfString(data) + &quot;] of length &quot; + data.length);
        
        try
        {
            // Echo the data back with the same parameters.
            endpoint.send(data, channel, false);
        }
        catch (TrapException e)
        {
            e.printStackTrace();
        }
    }
    
    public void trapClose(TrapEndpoint endpoint, Object context)
    {
        // Remove the strong reference to allow garbage collection
        clients.remove(endpoint);
    }
    
}</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/transport/ws/spi/WSServerImpl.java</td>
<td>TrAP Networking: Websockets using NIO</td>
<td><a href="./xref/com/ericsson/research/transport/ws/spi/WSServerImpl.html#L86">86</a></td></tr>
<tr class="b">
<td>com/ericsson/research/transport/ws/spi/WSServerImpl.java</td>
<td>TrAP Networking: Websockets using Sockets</td>
<td><a href="./xref/com/ericsson/research/transport/ws/spi/WSServerImpl.html#L93">93</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>			}
		}
	}
	
	public WSURI getURI() {
		String scheme = (securityContext==null ? &quot;ws&quot; : &quot;wss&quot;);

		InetSocketAddress inetAddress = getAddress();
		String host = inetAddress.getAddress().getHostAddress();
		int port = inetAddress.getPort();
		String resource = &quot;ws&quot;;
		
		byte[] address = inetAddress.getAddress().getAddress();
		boolean isv6 = address.length &gt; 4;
		
		if (isv6)
			host = &quot;[&quot; + host + &quot;]&quot;;

		try {
			return new WSURI(scheme + &quot;://&quot; + host + &quot;:&quot; + port + &quot;/&quot; + resource);
		} catch (IllegalArgumentException e) {</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/spi/transports/ListenerHttpTransport.java</td>
<td>Trap HTTP Server using Sun HTTP server</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/ListenerHttpTransport.html#L286">286</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/spi/transports/ServerSocketTransport.java</td>
<td>Socket Server using ER NIO</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/ServerSocketTransport.html#L131">131</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>            SSLContext sslc = null;
            
            if (this.getOption(CERT_USE_INSECURE_TEST) != null)
            {
                sslc = SSLUtil.getContext(new SSLMaterial(&quot;jks&quot;, &quot;trapserver.jks&quot;, &quot;Ericsson&quot;), new SSLMaterial(&quot;jks&quot;, &quot;trapserver.jks&quot;, &quot;Ericsson&quot;));
                this.logger.warn(&quot;Using insecure SSL context&quot;);
            }
            else
            {
                try
                {
                    String keyType = this.getOption(CERT_KEYSTORE_TYPE);
                    String keyName = this.getOption(CERT_KEYSTORE_NAME);
                    String keyPass = this.getOption(CERT_KEYSTORE_PASS);
                    
                    String trustType = this.getOption(CERT_TRUSTSTORE_TYPE);
                    String trustName = this.getOption(CERT_TRUSTSTORE_NAME);
                    String trustPass = this.getOption(CERT_TRUSTSTORE_PASS);</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/spi/transports/WebSocketTransport.java</td>
<td>TrAP Transport WebSocket by ER NIO</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/WebSocketTransport.html#L177">177</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/spi/transports/WebSocketTransport.java</td>
<td>TrAP Transport WebSocket by Netty</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/WebSocketTransport.html#L87">87</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>            WSInterface mSock = this.socket;
            
            if (mSock == null)
                throw new TrapTransportException(message, this.getState());
            
            synchronized (mSock)
            {
                
                byte[] raw = message.serialize();
                
                this.delayed |= this.lastSend == System.currentTimeMillis();
                this.delayed &amp;= this.useDelay;
                if (this.delayed &amp;&amp; !this.delayQueued)
                {
                    this.delayQueued = true;
                    ThreadPool.executeAfter(new Runnable() {
                        
                        @Override
                        public void run()
                        {
                            WebSocketTransport.this.flushTransport();
                        }
                    }, 1);
                }
                
                if (expectMore || this.delayed)</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/transport/ws/spi/WSHixie75Handshake.java</td>
<td>TrAP Networking: Websockets Base</td>
<td><a href="./xref/com/ericsson/research/transport/ws/spi/WSHixie75Handshake.html#L92">92</a></td></tr>
<tr class="b">
<td>com/ericsson/research/transport/ws/spi/WSHixie76Handshake.java</td>
<td>TrAP Networking: Websockets Base</td>
<td><a href="./xref/com/ericsson/research/transport/ws/spi/WSHixie76Handshake.html#L141">141</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>				throw new WSException(&quot;Failed to match origin (&quot;+protocol.origin+&quot; != &quot;+getHeader(WEBSOCKET_ORIGIN_HEADER)+&quot;)&quot;);
			StringBuffer location = new StringBuffer();
			if(protocol.securityContext!=null)
				location.append(WSS_SCHEMA);
			else
				location.append(WS_SCHEMA);
			location.append(protocol.host);
			if((protocol.securityContext==null &amp;&amp; protocol.port != 80) || (protocol.securityContext!=null &amp;&amp; protocol.port != 443)) {
				location.append(&quot;:&quot;);
				location.append(protocol.port);
			}
			location.append(protocol.resource);
			if (!location.toString().equals(getHeader(WEBSOCKET_LOCATION_HEADER)))</pre></div></td></tr></table>
<table border="0" class="table table-striped">
<tr class="b">
<th>File</th>
<th>Project</th>
<th>Line</th></tr>
<tr class="a">
<td>com/ericsson/research/trap/spi/transports/ListenerHttpTransport.java</td>
<td>Trap HTTP Server using Sun HTTP server</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/ListenerHttpTransport.html#L99">99</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/spi/transports/ServerWebSocketTransport.java</td>
<td>TrAP Transport WebSocket by ER NIO</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/ServerWebSocketTransport.html#L81">81</a></td></tr>
<tr class="a">
<td>com/ericsson/research/trap/spi/transports/WebServerSocketTransport.java</td>
<td>TrAP Transport WebSocket by Netty</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/WebServerSocketTransport.html#L89">89</a></td></tr>
<tr class="b">
<td>com/ericsson/research/trap/spi/transports/TomcatWSListener.java</td>
<td>TrAP Transport WebSocket for Tomcat Container</td>
<td><a href="./xref/com/ericsson/research/trap/spi/transports/TomcatWSListener.html#L96">96</a></td></tr>
<tr class="a"><td colspan='3'>
<div>
<pre>        this.delegate = new TrapTransportDelegate() {
            
            @Override
            public void ttStateChanged(TrapTransportState newState, TrapTransportState oldState, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }
            
            @Override
            public void ttMessageReceived(TrapMessage message, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }
            
            @Override
            public void ttMessageSent(TrapMessage message, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }

            @Override
            public void ttMessagesFailedSending(Collection&lt;TrapMessage&gt; messages, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }

            @Override
            public void ttNeedTransport(TrapMessage message, TrapTransport transport, Object context)
            {
                // TODO Auto-generated method stub
                
            }
        };</pre></div></td></tr></table></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2014
                        <a href="https://www.ericsson.com">Ericsson AB</a>.
            All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>